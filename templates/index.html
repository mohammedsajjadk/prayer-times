<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prayer Times</title>
  <link href="https://fonts.googleapis.com/css2?family=Digital-7&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}" />
</head>

<body>
  <!-- Container for the entire page -->
  <div class="container">
    <!-- Time and Date Display -->
    <!-- Time and Date Display -->
    <div class="time-display">
      <div class="time-wrapper">
        <span class="time-main">12:00</span>
        <span class="time-sub">
          <span class="seconds">00</span>
        </span>
      </div>
    </div>
    <div class="date-container">
      <div class="gregorian-date">{{ current_date }}</div>
      <div class="theme-dropdown">
        <button class="theme-button"></button>
        <div class="theme-content">
          <div class="theme-option" data-theme="theme1">Theme 1</div>
          <div class="theme-option" data-theme="theme2">Theme 2</div>
          <div class="theme-option" data-theme="theme3">Theme 3</div>
          <div class="theme-option" data-theme="theme4">Theme 4</div>
          <div class="theme-option" data-theme="theme5">Theme 5</div>
        </div>
      </div>
      <div class="islamic-date">{{ islamic_date }}</div>
    </div>
    <div class="divider"></div>
    <!-- Prayer Times Section -->
    <div class="prayer-times">
      <div class="beginning">
        <h2>BEGINNING</h2>
        <div class="prayer-time-value beginning" data-time="{{ today_prayer_times[2] }}"
          data-tomorrow="{{ tomorrow_prayer_times[2] }}">{{ today_prayer_times[2] }}
        </div>
        <div class="prayer-time-value beginning" data-time="{{ today_prayer_times[4] }}"
          data-tomorrow="{{ tomorrow_prayer_times[4] }}">{{ today_prayer_times[4] }}
        </div>
        <div class="prayer-time-value beginning" data-time="{{ today_prayer_times[5] }}"
          data-tomorrow="{{ tomorrow_prayer_times[5] }}">{{ today_prayer_times[5] }}
        </div>
        <div class="prayer-time-value beginning" data-time="{{ today_prayer_times[6] }}"
          data-tomorrow="{{ tomorrow_prayer_times[6] }}">{{ today_prayer_times[6] }}
        </div>
        <div class="prayer-time-value beginning" data-time="{{ today_prayer_times[7] }}"
          data-tomorrow="{{ tomorrow_prayer_times[7] }}">{{ today_prayer_times[7] }}
        </div>
        <div class="prayer-time-value beginning">&nbsp;</div>
      </div>
      <div class="prayer">
        <h2 class="empty-prayer-time-value">&nbsp;</h2>
        <div class="prayer-time-value prayer">
          <span class="english">FAJR</span>
          <span class="arabic">الفجر</span>
        </div>
        <div class="prayer-time-value prayer">
          <span class="english">ZOHR</span>
          <span class="arabic">الظهر</span>
        </div>
        <div class="prayer-time-value prayer">
          <span class="english">ASAR</span>
          <span class="arabic">العصر</span>
        </div>
        <div class="prayer-time-value prayer">
          <span class="english">MAGRIB</span>
          <span class="arabic">المغرب</span>
        </div>
        <div class="prayer-time-value prayer">
          <span class="english">ISHA</span>
          <span class="arabic">العشاء</span>
        </div>
        <div class="prayer-time-value prayer">
          <span class="english">JUMU'AH</span>
          <span class="arabic">الجمعة</span>
        </div>
      </div>
      <div class="jamaah">
        <h2>JAMA'AH</h2>
        <div class="prayer-time-value jamaah" data-time="{{ today_prayer_times[8] }}"
          data-tomorrow="{{ tomorrow_prayer_times[8] }}">{{ today_prayer_times[8] }}</div>
        <div class="prayer-time-value jamaah" data-time="{{ today_prayer_times[9] }}"
          data-tomorrow="{{ tomorrow_prayer_times[9] }}">{{ today_prayer_times[9] }}
        </div>
        <div class="prayer-time-value jamaah" data-time="{{ today_prayer_times[10] }}"
          data-tomorrow="{{ tomorrow_prayer_times[10] }}">{{ today_prayer_times[10] }}
        </div>
        <div class="prayer-time-value jamaah" data-time="{{ today_prayer_times[11] }}"
          data-tomorrow="{{ tomorrow_prayer_times[11] }}">{{ today_prayer_times[11] }}
        </div>
        <div class="prayer-time-value jamaah" data-time="{{ today_prayer_times[12] }}"
          data-tomorrow="{{ tomorrow_prayer_times[12] }}">{{ today_prayer_times[12] }}
        </div>
        <div class="prayer-time-value jamaah" id="jumuah-time" data-time="13:20">1:20</div>
      </div>
    </div>
    <div class="important-times">
      <div class="divider"></div>
      <div class="times-container">
        <div class="time-box">
          <div class="time-label">SUHOOR ENDS</div>
          <div class="time-value" data-time="{{ important_times.sehri_ends }}"
            data-tomorrow="{{ tomorrow_important_times.sehri_ends }}">{{ important_times.sehri_ends }}</div>
        </div>
        <div class="time-box">
          <div class="time-label">SUNRISE</div>
          <div class="time-value" data-time="{{ important_times.sunrise }}"
            data-tomorrow="{{ tomorrow_important_times.sunrise }}">{{ important_times.sunrise }}</div>
        </div>
        <div class="time-box">
          <div class="time-label">ZAWAL</div>
          <div class="time-value" data-time="{{ important_times.noon }}"
            data-tomorrow="{{ tomorrow_important_times.noon }}">{{ important_times.noon }}</div>
        </div>
      </div>
    </div>
    <!-- Announcement Scroll -->
    <div class="announcement">
      <p id="announcement-text">
        Silence, please. We are in the House of Allah. Kindly turn off your
        mobile.
      </p>
    </div>
    <!-- JavaScript -->
    <script>
      // TIME TESTING CONFIGURATION
      var testMode = {
        enabled: false,          // Set to true to enable test mode
        time: "22:45",           // Format: "HH:MM" (24-hour format)
        dayOfWeek: 5,            // 0=Sunday, 1=Monday, ..., 5=Friday, 6=Saturday

        // Returns current time in minutes since midnight (overrides actual time when enabled)
        getCurrentTimeMinutes: function () {
          if (this.enabled) {
            const parts = this.time.split(":");
            return parseInt(parts[0]) * 60 + parseInt(parts[1]);
          } else {
            const now = new Date();
            return now.getUTCHours() * 60 + now.getUTCMinutes();
          }
        },

        // Returns current day of week (overrides actual day when enabled)
        getCurrentDayOfWeek: function () {
          return this.enabled ? this.dayOfWeek : new Date().getDay();
        },

        // Gets a mock Date object for testing (limited functionality)
        getMockDate: function () {
          if (!this.enabled) return new Date();

          // Create a mock date based on the test time
          const now = new Date();
          const parts = this.time.split(":");
          const hours = parseInt(parts[0]);
          const minutes = parseInt(parts[1]);

          const mockDate = new Date();
          mockDate.setHours(hours);
          mockDate.setMinutes(minutes);
          mockDate.setSeconds(now.getSeconds());
          mockDate.setMilliseconds(now.getMilliseconds());

          // Override getDay method to return test day of week
          mockDate.getDay = () => this.dayOfWeek;

          // Also override getUTCDay to return the same test day
          mockDate.getUTCDay = () => this.dayOfWeek;

          // Override getUTCHours to return the same hours (no DST adjustment)
          mockDate.getUTCHours = () => hours;

          // Override getUTCMinutes
          mockDate.getUTCMinutes = () => minutes;

          // Override getUTCSeconds and getUTCMilliseconds
          mockDate.getUTCSeconds = () => now.getSeconds();
          mockDate.getUTCMilliseconds = () => now.getMilliseconds();

          // Override getTime - this value is still needed for comparison functions
          const timestamp = Date.UTC(
            now.getUTCFullYear(),
            now.getUTCMonth(),
            now.getUTCDate(),
            hours,
            minutes,
            now.getSeconds(),
            now.getMilliseconds()
          );
          mockDate.getTime = () => timestamp;

          return mockDate;
        }
      };
      // Utility functions
      var timeUtils = {
        timeToMinutes: function (timeStr) {
          var parts = timeStr.split(":");
          return parseInt(parts[0]) * 60 + parseInt(parts[1]);
        },

        addMinutes: function (timeStr, minutesToAdd) {
          var parts = timeStr.split(":");
          var hours = parseInt(parts[0]);
          var minutes = parseInt(parts[1]);
          var totalMinutes = hours * 60 + minutes + minutesToAdd;
          var newHours = Math.floor(totalMinutes / 60) % 24;
          var newMinutes = totalMinutes % 60;
          return this.padNumber(newHours, 2) + ":" + this.padNumber(newMinutes, 2);
        },

        padNumber: function (num, size) {
          var s = "000000000" + num;
          return s.substr(s.length - size);
        }
      };

      // DOM Selectors
      var selectors = {
        timeDisplay: ".time-display",
        prayerTimes: {
          fajrJamaah: ".jamaah .prayer-time-value:nth-child(2)",
          zohrJamaah: ".jamaah .prayer-time-value:nth-child(3)",
          asrJamaah: ".jamaah .prayer-time-value:nth-child(4)",
          magribJamaah: ".jamaah .prayer-time-value:nth-child(5)",
          ishaJamaah: ".jamaah .prayer-time-value:nth-child(6)",
          jumahJamaah: ".jamaah .prayer-time-value:nth-child(7)",
          fajrBeginning: ".beginning .prayer-time-value:nth-child(2)",
          zohrBeginning: ".beginning .prayer-time-value:nth-child(3)",
          asrBeginning: ".beginning .prayer-time-value:nth-child(4)",
          magribBeginning: ".beginning .prayer-time-value:nth-child(5)",
          ishaBeginning: ".beginning .prayer-time-value:nth-child(6)"
        },
        importantTimes: {
          sunrise: ".time-box:nth-child(2) .time-value",
          zawal: ".time-box:nth-child(3) .time-value"
        },
        announcement: "#announcement-text"
      };

      function updateTime() {
        var now = testMode.enabled ? testMode.getMockDate() : new Date();

        // Get time components, applying Irish offset only when NOT in test mode
        var hours, minutes, seconds;

        if (testMode.enabled) {
          // In test mode: use exactly what was set in testMode.time
          const parts = testMode.time.split(":");
          hours = parseInt(parts[0]);
          minutes = parseInt(parts[1]);
          seconds = now.getUTCSeconds(); // Keep seconds updating
        } else {
          // Normal mode: apply Irish time offset
          var isIrishSummerTime = isIrelandDST(now);
          var irishOffset = isIrishSummerTime ? 1 : 0;
          hours = now.getUTCHours() + irishOffset;
          hours = hours >= 24 ? hours - 24 : hours; // Handle day wraparound
          minutes = now.getUTCMinutes();
          seconds = now.getUTCSeconds();
        }

        // Check if current time matches any jamaah time
        if (seconds === 0) {
          checkForJamaahTimeMatch(hours, minutes, seconds);
        }

        // Format for display (12-hour format)
        hours = hours % 12 || 12;
        var formattedMinutes = timeUtils.padNumber(minutes, 2);
        var formattedSeconds = timeUtils.padNumber(seconds, 2);

        // Update the elements
        var timeMain = document.querySelector('.time-main');
        var secondsEl = document.querySelector('.seconds');

        if (timeMain) {
          timeMain.textContent = hours + ':' + formattedMinutes;
        }

        if (secondsEl) {
          secondsEl.textContent = formattedSeconds;
        }

        // Schedule next update
        if (window.timeUpdateTimeout) {
          clearTimeout(window.timeUpdateTimeout);
        }

        // Calculate time to next second
        var millisToNextSecond = 1000 - now.getUTCMilliseconds();
        millisToNextSecond = Math.max(millisToNextSecond, 10);

        // Schedule next update
        window.timeUpdateTimeout = setTimeout(updateTime, millisToNextSecond);
      }

      // To detect if Ireland is currently in DST (summer time)
      // To detect if Ireland is currently in DST (summer time)
      function isIrelandDST(date) {
        // Ireland's DST starts at 1am UTC on the last Sunday in March
        // and ends at 1am UTC on the last Sunday in October
        var year = date.getUTCFullYear();

        // Calculate last Sunday of March
        var lastDayMarch = new Date(Date.UTC(year, 2, 31)); // Start with March 31
        while (lastDayMarch.getUTCMonth() > 2) {
          // Adjust if we went to April (this happens because some months don't have 31 days)
          lastDayMarch = new Date(Date.UTC(year, 2, lastDayMarch.getUTCDate() - 1));
        }
        // Go back to the last Sunday
        while (lastDayMarch.getUTCDay() !== 0) {
          lastDayMarch = new Date(Date.UTC(year, 2, lastDayMarch.getUTCDate() - 1));
        }

        // Calculate last Sunday of October
        var lastDayOctober = new Date(Date.UTC(year, 9, 31)); // Start with October 31
        while (lastDayOctober.getUTCMonth() > 9) {
          // Adjust if we went to November
          lastDayOctober = new Date(Date.UTC(year, 9, lastDayOctober.getUTCDate() - 1));
        }
        // Go back to the last Sunday
        while (lastDayOctober.getUTCDay() !== 0) {
          lastDayOctober = new Date(Date.UTC(year, 9, lastDayOctober.getUTCDate() - 1));
        }

        // Set transition times (1am UTC)
        var dstStart = new Date(Date.UTC(year, lastDayMarch.getUTCMonth(),
          lastDayMarch.getUTCDate(), 1, 0, 0, 0));
        var dstEnd = new Date(Date.UTC(year, lastDayOctober.getUTCMonth(),
          lastDayOctober.getUTCDate(), 1, 0, 0, 0));

        // Get timestamp of the input date
        var timestamp = date.getTime();

        return timestamp >= dstStart.getTime() && timestamp < dstEnd.getTime();
      }

      // In your initialize function, add this line to remove any existing interval
      if (window.driftCheckInterval) {
        clearInterval(window.driftCheckInterval);

      }

      function checkForJamaahTimeMatch(hours, minutes, seconds) {
        // Only check when seconds is 0 to trigger exactly at the minute change
        if (seconds !== 0) return;

        var now = testMode.enabled ? testMode.getMockDate() : new Date();

        // For day-of-week, use test mode day if enabled, otherwise calculate Irish day
        var currentDay = testMode.enabled ? testMode.dayOfWeek : now.getUTCDay();

        // If not in test mode, handle Irish time day rollover
        if (!testMode.enabled) {
          var isIrishSummerTime = isIrelandDST(now);
          var irishOffset = isIrishSummerTime ? 1 : 0;
          var irishHours = now.getUTCHours() + irishOffset;

          if (irishHours < now.getUTCHours()) {
            currentDay = (currentDay + 1) % 7;
          }
        }

        var isFriday = testMode.enabled ? testMode.dayOfWeek === 5 : currentDay === 5;

        // Current time in HH:MM format (24-hour)
        var currentTime = timeUtils.padNumber(hours, 2) + ":" + timeUtils.padNumber(minutes, 2);

        // Get Zohr jamaah time
        var zohrJamaahTime = document.querySelector(selectors.prayerTimes.zohrJamaah).getAttribute('data-time');

        // Check all jamaah prayer times
        var jamaahTimes = [
          document.querySelector(selectors.prayerTimes.fajrJamaah).getAttribute('data-time'),
          document.querySelector(selectors.prayerTimes.asrJamaah).getAttribute('data-time'),
          document.querySelector(selectors.prayerTimes.magribJamaah).getAttribute('data-time'),
          document.querySelector(selectors.prayerTimes.ishaJamaah).getAttribute('data-time'),
        ];

        if (!isFriday) {
          jamaahTimes.push(zohrJamaahTime);
        }

        // If current time matches any prayer time, trigger the effect
        if (jamaahTimes.includes(currentTime)) {
          triggerPrayerTimeEffect();
        }
      }

      // Function to create the prayer time effect
      function triggerPrayerTimeEffect() {
        // Add the effect class to time display
        var timeDisplay = document.querySelector('.time-display');
        if (timeDisplay) {
          timeDisplay.classList.add('prayer-time-simple');

          // Remove the effect after 2 seconds
          setTimeout(function () {
            timeDisplay.classList.remove('prayer-time-simple');
          }, 2000);
        }
      }


      function convertTo12Hour() {
        var elements = document.querySelectorAll(".prayer-time-value.beginning, .prayer-time-value.jamaah");
        for (var i = 0; i < elements.length; i++) {
          var el = elements[i];
          var time = el.getAttribute("data-time");
          if (time && time.indexOf(":") !== -1) {
            var parts = time.split(":");
            var hours = parseInt(parts[0]);
            var minutes = parseInt(parts[1]);
            if (!isNaN(hours) && !isNaN(minutes)) {
              var hours12 = hours % 12 || 12;
              el.textContent = hours12 + ":" + timeUtils.padNumber(minutes, 2);
            }
          }
        }
        
        // Explicitly convert important times (including Zawal)
        var importantTimes = document.querySelectorAll(".time-box .time-value");
        for (var i = 0; i < importantTimes.length; i++) {
          var el = importantTimes[i];
          var time = el.getAttribute("data-time");
          if (time && time.indexOf(":") !== -1) {
            var parts = time.split(":");
            var hours = parseInt(parts[0]);
            var minutes = parseInt(parts[1]);
            if (!isNaN(hours) && !isNaN(minutes)) {
              var hours12 = hours % 12 || 12;
              el.textContent = hours12 + ":" + timeUtils.padNumber(minutes, 2);
            }
          }
        }
      }

      function updateNextPrayer() {
        var now = testMode.enabled ? testMode.getMockDate() : new Date();

        // Get current time in minutes from midnight
        var currentTime;
        if (testMode.enabled) {
          // In test mode, use exactly what was set
          const parts = testMode.time.split(":");
          currentTime = parseInt(parts[0]) * 60 + parseInt(parts[1]);
        } else {
          // Normal mode: apply Irish time offset
          var isIrishSummerTime = isIrelandDST(now);
          var irishOffset = isIrishSummerTime ? 1 : 0;
          var irishHours = now.getUTCHours() + irishOffset;
          irishHours = irishHours >= 24 ? irishHours - 24 : irishHours;
          currentTime = irishHours * 60 + now.getUTCMinutes();
        }

        // For day-of-week, we need to account for day rollover when Irish time is ahead
        var currentDay = testMode.enabled ? testMode.dayOfWeek : now.getUTCDay();
        if (!testMode.enabled && irishHours < now.getUTCHours()) {
          currentDay = (currentDay + 1) % 7;
        }

        var isJumuah = currentDay === 5; // 0 is Sunday, 5 is Friday

        var currentDate = now.getUTCDate();
        var currentMonth = now.getUTCMonth() + 1; // JavaScript months are 0-based
        var currentYear = now.getUTCFullYear();

        // Check if today is the day before a clock change
        var isDayBeforeClockChange = isDateBeforeClockChange(currentDate, currentMonth, currentYear);

        // Clear existing highlights
        var highlighted = document.querySelectorAll(".next-prayer");
        for (var i = 0; i < highlighted.length; i++) {
          highlighted[i].classList.remove("next-prayer");
        }

        // Don't highlight next prayer on day before clock change
        if (isDayBeforeClockChange) {
          return;
        }

        // Get all required times
        var times = {
          fajrBeginning: timeUtils.timeToMinutes(document.querySelector(".beginning .prayer-time-value:nth-child(2)").getAttribute('data-time')),
          zohrBeginning: timeUtils.timeToMinutes(document.querySelector(".beginning .prayer-time-value:nth-child(3)").getAttribute('data-time')),
          asrBeginning: timeUtils.timeToMinutes(document.querySelector(".beginning .prayer-time-value:nth-child(4)").getAttribute('data-time')),
          magribBeginning: timeUtils.timeToMinutes(document.querySelector(".beginning .prayer-time-value:nth-child(5)").getAttribute('data-time')),
          ishaBeginning: timeUtils.timeToMinutes(document.querySelector(".beginning .prayer-time-value:nth-child(6)").getAttribute('data-time')),
          sunrise: timeUtils.timeToMinutes(document.querySelector(selectors.importantTimes.sunrise).getAttribute('data-time')),
          zawal: timeUtils.timeToMinutes(document.querySelector(selectors.importantTimes.zawal).getAttribute('data-time'))
        };

        // Check for prohibited times
        var isProhibitedTime = (
          (currentTime >= times.sunrise && currentTime < times.sunrise + 15) ||
          (currentTime >= times.zawal && currentTime < times.zawal + 10) ||
          (currentTime >= times.magribBeginning - 10 && currentTime < times.magribBeginning)
        );

        if (isProhibitedTime) {
          return;
        }

        var nextPrayer = null;

        if (currentTime >= 0 && currentTime < times.fajrBeginning) {
          nextPrayer = 'isha';
        } else if (currentTime >= times.fajrBeginning && currentTime < times.sunrise) {
          nextPrayer = 'fajr';
        } else if (isJumuah && currentTime >= times.zohrBeginning && currentTime < times.asrBeginning) {
          nextPrayer = 'jumuah';
        } else if (currentTime >= times.zohrBeginning && currentTime < times.asrBeginning) {
          nextPrayer = 'zohr';
        } else if (currentTime >= times.asrBeginning && currentTime < times.magribBeginning - 10) {
          nextPrayer = 'asr';
        } else if (currentTime >= times.magribBeginning && currentTime < times.ishaBeginning) {
          nextPrayer = 'magrib';
        } else if (currentTime >= times.ishaBeginning) {
          nextPrayer = 'isha';
        }

        if (nextPrayer) {
          highlightNextPrayer(nextPrayer, isJumuah);
        }
      }

      // To check if a date is the day before a clock change
      function isDateBeforeClockChange(date, month, year) {
        // Last Sunday in March (day before Spring clock change)
        var lastSundayMarch = getLastSundayOfMonth(year, 3); // March is month 3
        var dayBeforeSpringChange = new Date(lastSundayMarch);
        dayBeforeSpringChange.setDate(dayBeforeSpringChange.getDate() - 1);

        // Last Sunday in October (day before Fall clock change)
        var lastSundayOctober = getLastSundayOfMonth(year, 10); // October is month 10
        var dayBeforeFallChange = new Date(lastSundayOctober);
        dayBeforeFallChange.setDate(dayBeforeFallChange.getDate() - 1);

        // Check if today is the day before a clock change
        var today = new Date(year, month - 1, date); // Adjust month back to 0-based
        return (
          (today.getDate() === dayBeforeSpringChange.getDate() && today.getMonth() === dayBeforeSpringChange.getMonth()) ||
          (today.getDate() === dayBeforeFallChange.getDate() && today.getMonth() === dayBeforeFallChange.getMonth())
        );
      }

      // To get last Sunday of a given month
      // To get last Sunday of a given month
      function getLastSundayOfMonth(year, month) {
        var date = new Date(year, month, 0); // Last day of the month

        // Move back until we reach a Sunday (day 0)
        while (date.getDay() !== 0) {
          date.setDate(date.getDate() - 1);
        }

        return date.getDate();
      }


      function highlightNextPrayer(prayer, isJumuah) {
        var prayerIndex = {
          fajr: 2,
          zohr: 3,
          asr: 4,
          magrib: 5,
          isha: 6,
          jumuah: 7
        };
        var element = document.querySelector(".jamaah .prayer-time-value:nth-child(" + prayerIndex[prayer] + ")");
        if (element) {
          // Apply special highlight for Jumu'ah
          if (prayer === 'jumuah') {
            element.classList.add("jumuah-highlight");
          } else {
            element.classList.add("next-prayer");
          }
        }
      }

      var announcements = {
        default: "SILENCE, PLEASE. WE ARE IN THE HOUSE OF ALLAH. KINDLY TURN OFF YOUR MOBILE.",
        spiritual_weekend: "SPIRITUAL WEEKEND WITH ULAMA FROM UK • Check notice board for further details",

        thursday_darood: function () {
          return "DUROOD/SALAT-ALA-NABI صلى الله عليه وسلم GATHERING • THURSDAY AFTER MAGRIB"
        },
        friday_tafseer: function () {
          return "TAFSEER OF THE QUR'AN • SURAH QAAF • FRIDAY AFTER MAGRIB"
        },
        clock_go_forward: function () {
          return "REMEMBER CLOCKS GO FORWARD 1 HOUR THIS SUNDAY"
        },
        clock_go_backward: function () {
          return "REMEMBER CLOCKS GO BACKWARD 1 HOUR THIS SUNDAY"
        },
        special_sessions: {
          umrah: "UPCOMING PROGRAM • HOW TO PERFORM UMRAH • WEDNESDAY AFTER MAGRIB",
          hajj: "UPCOMING PROGRAM • HOW TO PERFORM HAJJ • THURSDAY AFTER MAGRIB",
          madeenah: "UPCOMING PROGRAM • SESSION 3: VISIT TO MADEENAH MUNAWWARAH • FRIDAY AFTER MAGRIB",
          all_sessions: "UPCOMING PROGRAMS • SESSION 1: HOW TO PERFORM UMRAH (WED AFTER MAGRIB) • SESSION 2: HOW TO PERFORM HAJJ (THURS AFTER MAGRIB) • SESSION 3: VISIT TO MADEENAH MUNAWWARAH (FRI AFTER MAGRIB)",
          hajj_madeenah: "UPCOMING PROGRAMS • SESSION 2: HOW TO PERFORM HAJJ (THURS AFTER MAGRIB) • SESSION 3: VISIT TO MADEENAH MUNAWWARAH (FRI AFTER MAGRIB)"
        },
        warnings: {
          sunrise: function (sunriseTime, endTime) {
            return "NO SALAH AFTER SUNRISE (" + formatTimeWithAmPm(sunriseTime) + ") • Please Wait Until " + formatTimeWithAmPm(endTime);
          },
          zawal: function (zawalTime, zohrTime) {
            return "NO SALAH AT ZAWAL TIME (" + formatTimeWithAmPm(zawalTime) + ") • Please Wait for Zohr to Begin (" + formatTimeWithAmPm(zohrTime) + ")";
          },
          sunset: function (magribTime) {
            return "NO SALAH DURING SUNSET • Please Wait for Magrib Adhan (" + formatTimeWithAmPm(magribTime) + ")";
          }
        }
      };

      // Add this function before the initialize() function
      function formatTimeWithAmPm(timeStr) {
        if (!timeStr || timeStr.indexOf(":") === -1) return timeStr;

        var parts = timeStr.split(":");
        var hours24 = parseInt(parts[0], 10);
        var minutes = parseInt(parts[1], 10);

        if (isNaN(hours24) || isNaN(minutes)) return timeStr;

        var period = hours24 >= 12 ? "PM" : "AM";
        var hours12 = hours24 % 12 || 12;

        return hours12 + ":" + timeUtils.padNumber(minutes, 2) + period;
      }

      // Add function to check if date is within the spiritual weekend period
      function isWithinSpiritualWeekend(now) {
        if (testMode.enabled) {
          now = testMode.getMockDate();
        }
        
        // Spiritual Weekend dates (May 18-25, 2025)
        var weekendStart = new Date(Date.UTC(2025, 4, 18, 0, 0, 0)); // May 18, 2025 00:00 UTC
        var weekendEnd = new Date(Date.UTC(2025, 4, 25, 19, 20, 0)); // May 25, 2025 19:20 UTC
        
        // Current time
        var currentTime = now.getTime();
        
        // Check if we're in the period
        return currentTime >= weekendStart.getTime() && currentTime <= weekendEnd.getTime();
      }

      // Add function to check if date is within the special session periods
      function checkSpecialSessionPeriod(now) {
        if (testMode.enabled) {
          now = testMode.getMockDate();
        }
        
        // Special session dates (May 2025)
        var specialStart = new Date(Date.UTC(2025, 4, 10, 0, 0, 0)); // May 11, 2025 00:00 UTC
        var session1End = new Date(Date.UTC(2025, 4, 14)); // May 13, 2025
        var session2End = new Date(Date.UTC(2025, 4, 15)); // May 14, 2025
        var session3End = new Date(Date.UTC(2025, 4, 16)); // May 15, 2025
        
        // Get magrib jamaah times for the session end days
        var magribJamaahEl = document.querySelector(selectors.prayerTimes.magribJamaah);
        var magribJamaahTime = magribJamaahEl ? magribJamaahEl.getAttribute('data-time') : "19:00"; // Default fallback
        
        if (magribJamaahTime && magribJamaahTime.indexOf(':') !== -1) {
          var timeParts = magribJamaahTime.split(':');
          var magribHours = parseInt(timeParts[0]);
          var magribMins = parseInt(timeParts[1]);
          
          // Set end times to Magrib Jamaah + 5 mins
          session1End.setUTCHours(magribHours, magribMins + 5, 0, 0);
          session2End.setUTCHours(magribHours, magribMins + 5, 0, 0);
          session3End.setUTCHours(magribHours, magribMins + 5, 0, 0);
          
          // Set start times for sessions 2 and 3 to Magrib Jamaah + 6 mins of the previous day
          var session1EndPlus1 = new Date(session1End);
          session1EndPlus1.setUTCMinutes(session1End.getUTCMinutes() + 1);
          
          var session2EndPlus1 = new Date(session2End);
          session2EndPlus1.setUTCMinutes(session2End.getUTCMinutes() + 1);
        }
        
        // Current time
        var currentTime = now.getTime();
        
        // Check which period we're in
        if (currentTime >= specialStart && currentTime <= session1End) {
          return "all_sessions";
        } else if (currentTime > session1End && currentTime <= session2End) {
          return "hajj_madeenah";
        } else if (currentTime > session2End && currentTime <= session3End) {
          return "madeenah";
        }
        
        return null;
      }

      function showNextMessage(message) {
        var announcementElement = document.querySelector(selectors.announcement);
        if (!announcementElement) return;

        // Set the message
        announcementElement.textContent = message;

        // Add class for older browsers
        if (announcementElement.classList) {
          announcementElement.classList.add('scroll-announcement');
        } else {
          // Fallback for older browsers without classList
          announcementElement.className += ' scroll-announcement';
        }
        isScrolling = true;

        // Wait for animation to complete
        setTimeout(function () {
          // Remove class for older browsers
          if (announcementElement.classList) {
            announcementElement.classList.remove('scroll-announcement');
          } else {
            // Fallback for older browsers
            announcementElement.className = announcementElement.className
              .replace(/\bscroll-announcement\b/, '');
          }
          isScrolling = false;

          // Small delay before next message
          setTimeout(function () {
            if (messageQueue && messageQueue.length > 0) {
              showNextMessage(messageQueue.shift());
            }
          }, 3000);
        }, 25000);
      }

      // Add a simple polyfill for classList
      function hasClass(el, className) {
        if (el.classList) {
          return el.classList.contains(className);
        } else {
          return new RegExp('\\b' + className + '\\b').test(el.className);
        }
      }

      function addClass(el, className) {
        if (el.classList) {
          el.classList.add(className);
        } else if (!hasClass(el, className)) {
          el.className += ' ' + className;
        }
      }

      function removeClass(el, className) {
        if (el.classList) {
          el.classList.remove(className);
        } else {
          el.className = el.className.replace(new RegExp('\\b' + className + '\\b', 'g'), '');
        }
      }

      function updateJumuahTimes() {
        var now = testMode.enabled ? testMode.getMockDate() : new Date();

        // Get current time in minutes from midnight
        var currentTime;
        if (testMode.enabled) {
          // In test mode, use exactly what was set
          const parts = testMode.time.split(":");
          currentTime = parseInt(parts[0]) * 60 + parseInt(parts[1]);
        } else {
          // Normal mode: apply Irish time offset
          var isIrishSummerTime = isIrelandDST(now);
          var irishOffset = isIrishSummerTime ? 1 : 0;
          var irishHours = now.getUTCHours() + irishOffset;
          irishHours = irishHours >= 24 ? irishHours - 24 : irishHours;
          currentTime = irishHours * 60 + now.getUTCMinutes();
        }

        // For day-of-week, handle potential day rollover
        var currentDay = testMode.enabled ? testMode.dayOfWeek : now.getUTCDay();
        if (!testMode.enabled && irishHours < now.getUTCHours()) {
          currentDay = (currentDay + 1) % 7;
        }

        var isFriday = currentDay === 5;

        // Determine if it's Summer Time or Winter Time
        var isIrishSummerTime = isIrelandDST(now);

        // Set Jumuah time based on whether it's Summer Time or Winter Time
        var jumuahTime;
        if (isIrishSummerTime) {
          // Summer Time
          jumuahTime = "13:45";
        } else {
          // Winter Time
          jumuahTime = "13:20";
        }

        // Get the Jumuah time element
        var jumuahElement = document.querySelector(".jamaah .prayer-time-value:nth-child(7)");

        // Get the Jumuah label element
        var jumuahLabelElement = document.querySelector(".prayer .prayer-time-value:nth-child(7) .english");

        // Get Zohr beginning time and Asr beginning time to determine when to highlight Jumuah
        var zohrBeginningEl = document.querySelector(".beginning .prayer-time-value:nth-child(3)");
        var asrBeginningEl = document.querySelector(".beginning .prayer-time-value:nth-child(4)");

        var zohrBeginningTime = 0;
        var asrBeginningTime = 15 * 60; // Default to 3 PM if format is invalid

        if (zohrBeginningEl && zohrBeginningEl.getAttribute('data-time')) {
          var zohrTimeStr = zohrBeginningEl.getAttribute('data-time');
          var zohrParts = zohrTimeStr.split(":");
          if (zohrParts.length === 2) {
            zohrBeginningTime = parseInt(zohrParts[0]) * 60 + parseInt(zohrParts[1]);
          }
        }

        if (asrBeginningEl && asrBeginningEl.getAttribute('data-time')) {
          var asrTimeStr = asrBeginningEl.getAttribute('data-time');
          var asrParts = asrTimeStr.split(":");
          if (asrParts.length === 2) {
            asrBeginningTime = parseInt(asrParts[0]) * 60 + parseInt(asrParts[1]);
          }
        }

        // Update to the correct Jumuah time
        jumuahElement.textContent = formatTimeFor12Hour(jumuahTime);
        jumuahElement.setAttribute("data-time", jumuahTime);

        // Make sure the label is correct
        if (jumuahLabelElement && jumuahLabelElement.textContent.includes("2nd")) {
          jumuahLabelElement.textContent = "JUMU'AH";
        }

        // Remove any existing highlight first
        jumuahElement.classList.remove("jumuah-highlight");
        jumuahElement.classList.remove("next-prayer");

        // Only highlight Jumuah on Friday between Zohr beginning and Asr beginning
        if (isFriday && currentTime >= zohrBeginningTime && currentTime < asrBeginningTime) {
          jumuahElement.classList.add("jumuah-highlight");
        }

        // If it's Friday after Asr begins, make sure Asr gets highlighted if it's before Maghrib
        if (isFriday && currentTime >= asrBeginningTime) {
          var asrJamaahEl = document.querySelector(".jamaah .prayer-time-value:nth-child(4)");
          var magribBeginningEl = document.querySelector(".beginning .prayer-time-value:nth-child(5)");

          if (asrJamaahEl && magribBeginningEl) {
            var magribTimeStr = magribBeginningEl.getAttribute('data-time');
            var magribParts = magribTimeStr.split(":");
            if (magribParts.length === 2) {
              var magribBeginningTime = parseInt(magribParts[0]) * 60 + parseInt(magribParts[1]);
              if (currentTime < magribBeginningTime - 10) {
                asrJamaahEl.classList.add("next-prayer");
              }
            }
          }
        }
      }

      function updateAnnouncement() {
        var now = testMode.enabled ? testMode.getMockDate() : new Date();

        // Get current time in minutes from midnight
        var currentTime;
        if (testMode.enabled) {
          // In test mode, use exactly what was set
          const parts = testMode.time.split(":");
          currentTime = parseInt(parts[0]) * 60 + parseInt(parts[1]);
        } else {
          // Normal mode: apply Irish time offset
          var isIrishSummerTime = isIrelandDST(now);
          var irishOffset = isIrishSummerTime ? 1 : 0;
          var irishHours = now.getUTCHours() + irishOffset;
          irishHours = irishHours >= 24 ? irishHours - 24 : irishHours;
          currentTime = irishHours * 60 + now.getUTCMinutes();
        }

        // For day-of-week, handle potential day rollover
        var currentDay = testMode.enabled ? testMode.dayOfWeek : now.getUTCDay();
        if (!testMode.enabled && irishHours < now.getUTCHours()) {
          currentDay = (currentDay + 1) % 7;
        }

        var dayOfWeek = currentDay; // 0 is Sunday, 5 is Friday, 6 is Saturday

        // Determine if it's summer or winter time
        var isIrishSummerTime = isIrelandDST(now);

        // Continue with regular announcement code
        var times = {
          sunrise: document.querySelector(selectors.importantTimes.sunrise).getAttribute('data-time'),
          zawal: document.querySelector(selectors.importantTimes.zawal).getAttribute('data-time'),
          fajrBeginning: document.querySelector(selectors.prayerTimes.fajrBeginning).getAttribute('data-time'),
          zohrBeginning: document.querySelector(selectors.prayerTimes.zohrBeginning).getAttribute('data-time'),
          magribBeginning: document.querySelector(selectors.prayerTimes.magribBeginning).getAttribute('data-time'),
          asrJamaah: document.querySelector(selectors.prayerTimes.asrJamaah).getAttribute('data-time'),
          magribJamaah: document.querySelector(selectors.prayerTimes.magribJamaah).getAttribute('data-time'),
          ishaJamaah: document.querySelector(selectors.prayerTimes.ishaJamaah).getAttribute('data-time')
        };

        // Convert times
        var sunriseTime = timeUtils.timeToMinutes(times.sunrise);
        var zawalTime = timeUtils.timeToMinutes(times.zawal);
        var fajrTime = timeUtils.timeToMinutes(times.fajrBeginning);
        var zohrTime = timeUtils.timeToMinutes(times.zohrBeginning);
        var magribTime = timeUtils.timeToMinutes(times.magribBeginning);
        var asrJamaahTime = timeUtils.timeToMinutes(times.asrJamaah);
        var magribJamaahTime = timeUtils.timeToMinutes(times.magribJamaah);
        var ishaJamaahTime = timeUtils.timeToMinutes(times.ishaJamaah);

        var announcementElement = document.querySelector(selectors.announcement);
        var message = announcements.default;
        var isWarning = false;
        var isSpecialAnnouncement = false;
        
        // First check if we're in the spiritual weekend period
        if (isWithinSpiritualWeekend(now)) {
          message = announcements.spiritual_weekend;
          isSpecialAnnouncement = true;
        } 
        // Then check for special session periods
        else {
          var specialSessionPeriod = checkSpecialSessionPeriod(now);
          if (specialSessionPeriod) {
            message = announcements.special_sessions[specialSessionPeriod];
            isSpecialAnnouncement = true;
          } else {
            // Regular announcements logic
            if (isIrishSummerTime) {
              if (dayOfWeek === 4 && currentTime >= fajrTime && currentTime < magribJamaahTime + 5) {
                // Thursday
                message = announcements.thursday_darood();
              }
              else if (dayOfWeek === 4 && currentTime >= magribJamaahTime + 6 && currentTime < (23 * 60 + 59)) {
                // Thursday After Magrib
                message = announcements.friday_tafseer();
              }
              else if (dayOfWeek === 5 && currentTime > (0 * 60 + 1) && currentTime < magribJamaahTime + 10) {
                // Friday
                message = announcements.friday_tafseer();
              }
            } else {
              // Winter time rules
              if (dayOfWeek === 4 && currentTime >= fajrTime && currentTime < ishaJamaahTime + 5) {
                // Thursday
                message = announcements.thursday_darood();
              }
              else if (dayOfWeek === 4 && currentTime >= ishaJamaahTime + 6 && currentTime < (23 * 60 + 59)) {
                // Thursday After Isha
                message = announcements.friday_tafseer();
              }
              else if (dayOfWeek === 5 && currentTime > (0 * 60 + 1) && currentTime < ishaJamaahTime + 10) {
                // Friday
                message = announcements.friday_tafseer();
              }
            }
          }
        }


        // Then check for warnings (which take precedence over any other messages)
        if (currentTime >= sunriseTime && currentTime < sunriseTime + 15) {
          message = announcements.warnings.sunrise(times.sunrise, timeUtils.addMinutes(times.sunrise, 15));
          isWarning = true;
          isSpecialAnnouncement = false;
        } else if (currentTime >= zawalTime && currentTime < zawalTime + 10) {
          message = announcements.warnings.zawal(times.zawal, times.zohrBeginning);
          isWarning = true;
          isSpecialAnnouncement = false;
        } else if (currentTime >= magribTime - 10 && currentTime < magribTime) {
          message = announcements.warnings.sunset(times.magribBeginning);
          isWarning = true;
          isSpecialAnnouncement = false;
        }

        if (announcementElement) {
          // Set the message text
          announcementElement.textContent = message;

          // Remove all classes first
          announcementElement.classList.remove("announcement-text-normal", "announcement-text-long", "announcement-text-very-long");
          announcementElement.classList.remove("announcement-warning", "special-announcement");
          document.querySelector(".announcement").classList.remove("warning-active", "special-active");

          // Add appropriate animation class based on message length
          if (message.length < 60) {
            announcementElement.classList.add("announcement-text-normal");
          } else if (message.length < 100) {
            announcementElement.classList.add("announcement-text-long");
          } else {
            announcementElement.classList.add("announcement-text-very-long");
          }

          // Add styling classes (warning takes priority)
          if (isWarning) {
            announcementElement.classList.add("announcement-warning");
            document.querySelector(".announcement").classList.add("warning-active");
          } else if (isSpecialAnnouncement) {
            announcementElement.classList.add("special-announcement");
            document.querySelector(".announcement").classList.add("special-active");
          }
        }
      }

      // Function to update prayer times to next day when appropriate
      function updateToNextDayTimesIfNeeded() {
        var now = testMode.enabled ? testMode.getMockDate() : new Date();

        // Get Irish time
        var isIrishSummerTime = isIrelandDST(now);
        var irishOffset = isIrishSummerTime ? 1 : 0;
        var irishHours = now.getUTCHours() + irishOffset;
        irishHours = irishHours >= 24 ? irishHours - 24 : irishHours;

        var currentTime = irishHours * 60 + now.getUTCMinutes();

        // For day-of-week, use test mode day if enabled, otherwise calculate Irish day
        var currentDay = testMode.enabled ? testMode.dayOfWeek : now.getUTCDay();
        if (!testMode.enabled && irishHours < now.getUTCHours()) {
          currentDay = (currentDay + 1) % 7;
        }

        var isFriday = currentDay === 5;

        // Update sunrise if it's past sunrise + 120 mins
        var sunriseEl = document.querySelector(".time-box:nth-child(2) .time-value");
        if (sunriseEl) {
          var sunriseTime = sunriseEl.getAttribute("data-time");
          if (sunriseTime) {
            var sunriseMinutes = timeUtils.timeToMinutes(sunriseTime);
            var sunriseThreshold = sunriseMinutes + 120;

            if (currentTime >= sunriseThreshold) {
              var tomorrowSunrise = sunriseEl.getAttribute("data-tomorrow");
              if (tomorrowSunrise) {
                sunriseEl.setAttribute("data-time", tomorrowSunrise);
                sunriseEl.textContent = formatTimeFor12Hour(tomorrowSunrise);
              }
            }
          }
        }

        // Update zawal separately - only when 120 minutes past zawal time
        var zawalEl = document.querySelector(".time-box:nth-child(3) .time-value");
        if (zawalEl) {
          var zawalTime = zawalEl.getAttribute("data-time");
          if (zawalTime) {
            var zawalMinutes = timeUtils.timeToMinutes(zawalTime);
            var zawalThreshold = zawalMinutes + 120;

            if (currentTime >= zawalThreshold) {
              var tomorrowZawal = zawalEl.getAttribute("data-tomorrow");
              if (tomorrowZawal) {
                zawalEl.setAttribute("data-time", tomorrowZawal);
                zawalEl.textContent = formatTimeFor12Hour(tomorrowZawal);
              }
            }
          }
        }


        // Define prayer types to update (excluding Jumu'ah)
        var prayers = ['fajr', 'zohr', 'asr', 'magrib', 'isha'];

        // For each prayer time
        prayers.forEach(function (prayer) {
          // Get indices based on prayer name
          var index = prayer === 'fajr' ? 2 :
            prayer === 'zohr' ? 3 :
              prayer === 'asr' ? 4 :
                prayer === 'magrib' ? 5 :
                  prayer === 'isha' ? 6 : null;

          if (index) {
            // Get current beginning and jamaah elements
            var beginningEl = document.querySelector(".beginning .prayer-time-value:nth-child(" + index + ")");
            var jamaahEl = document.querySelector(".jamaah .prayer-time-value:nth-child(" + index + ")");

            // Skip Jumu'ah processing on Fridays for Zohr
            if (isFriday && prayer === 'zohr') {
              return;
            }

            // Get current jamaah time
            var jamaahTime = jamaahEl.getAttribute('data-time');

            // Safety check for elements and attributes
            if (!beginningEl || !jamaahEl || !jamaahTime) {
              return;
            }

            // Calculate current jamaah minutes + 5 minutes
            var jamaahMinutes = timeUtils.timeToMinutes(jamaahTime);
            var thresholdTime = jamaahMinutes + 5;

            // If current time is past jamaah + 5 minutes, update to tomorrow's times
            if (currentTime >= thresholdTime) {
              // Get next day's times from data attributes we'll store
              var tomorrowBeginning = beginningEl.getAttribute('data-tomorrow');
              var tomorrowJamaah = jamaahEl.getAttribute('data-tomorrow');

              // Only update if we have tomorrow's data
              if (tomorrowBeginning && tomorrowJamaah) {
                // Update actual elements with tomorrow's times
                beginningEl.setAttribute('data-time', tomorrowBeginning);
                jamaahEl.setAttribute('data-time', tomorrowJamaah);

                beginningEl.textContent = formatTimeFor12Hour(tomorrowBeginning);
                jamaahEl.textContent = formatTimeFor12Hour(tomorrowJamaah);

                // Update Sehri time when Fajr time is updated
                if (prayer === 'fajr') {
                  var sehriEl = document.querySelector(".time-box:nth-child(1) .time-value");
                  if (sehriEl) {
                    var tomorrowSehri = sehriEl.getAttribute("data-tomorrow");
                    if (tomorrowSehri) {
                      sehriEl.setAttribute("data-time", tomorrowSehri);
                      sehriEl.textContent = formatTimeFor12Hour(tomorrowSehri);
                    }
                  }
                }
              }
            }
          }
        });
      }

      function formatTimeFor12Hour(timeStr) {
        if (timeStr && timeStr.indexOf(":") !== -1) {
          var parts = timeStr.split(":");
          var hours = parseInt(parts[0]);
          var minutes = parseInt(parts[1]);
          if (!isNaN(hours) && !isNaN(minutes)) {
            var hours12 = hours % 12 || 12;
            return hours12 + ":" + timeUtils.padNumber(minutes, 2);
          }
        }
        return timeStr;
      }


      function forceMidnightRefresh() {
        var now = testMode.enabled ? testMode.getMockDate() : new Date();

        // Get Irish time
        var isIrishSummerTime = isIrelandDST(now);
        var irishOffset = isIrishSummerTime ? 1 : 0;
        var irishHours = now.getUTCHours() + irishOffset;
        irishHours = irishHours >= 24 ? irishHours - 24 : irishHours;
        var irishMins = now.getUTCMinutes();
        var irishSecs = now.getUTCSeconds();

        if ((irishHours === 0 && irishMins === 0 && irishSecs <= 2)
          (irishHours === 16 && irishMins === 30 && irishSecs <= 2)) {
          persistentRefresh();
        }
      }

      function persistentRefresh() {
        var retryInterval = 30000;
        var url = window.location.pathname + "?t=" + new Date().getTime();

        function tryRefresh() {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', url, true);
          xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
              if (xhr.status === 200) {
                window.location.reload(true);
              } else {
                setTimeout(tryRefresh, retryInterval);
              }
            }
          };
          xhr.send();
        }

        tryRefresh();
      }

      function initialize() {
        // Initial updates
        updateTime();
        updateNextPrayer();
        updateAnnouncement();
        convertTo12Hour();

        // Set initial Jumuah time based on Summer/Winter time on page load
        var now = testMode.enabled ? testMode.getMockDate() : new Date();
        var isIrishSummerTime = isIrelandDST(now);
        var jumuahElement = document.querySelector(".jamaah .prayer-time-value:nth-child(7)");
        if (jumuahElement) {
          var jumuahTime = isIrishSummerTime ? "13:45" : "13:20";
          jumuahElement.setAttribute("data-time", jumuahTime);
          jumuahElement.textContent = formatTimeFor12Hour(jumuahTime);
        }
        updateJumuahTimes();
        updateToNextDayTimesIfNeeded();

        // Store interval reference for cleanup
        window.mainInterval = setInterval(function () {
          // Handle regular UI updates
          updateNextPrayer();
          updateAnnouncement();
          convertTo12Hour();
          updateJumuahTimes();
          updateToNextDayTimesIfNeeded();

          // Check for midnight refresh and 11:30 AM refresh
          var now = testMode.enabled ? testMode.getMockDate() : new Date();
          var isIrishSummerTime = isIrelandDST(now);
          var irishOffset = isIrishSummerTime ? 1 : 0;
          var irishHours = now.getUTCHours() + irishOffset;
          irishHours = irishHours >= 24 ? irishHours - 24 : irishHours;
          var irishMins = now.getUTCMinutes();
          var irishSecs = now.getUTCSeconds();

          if ((irishHours === 0 && irishMins === 0 && irishSecs <= 2) ||
            (irishHours === 16 && irishMins === 30 && irishSecs <= 2)) {
            persistentRefresh();
          }

          // Lighter drift checking - only once every 10 seconds
          if (now.getUTCSeconds() % 10 === 0) {
            var displayedSeconds = document.querySelector('.time-sub .seconds');
            if (displayedSeconds) {
              var displayedSecondsValue = parseInt(displayedSeconds.textContent, 10);
              if (isNaN(displayedSecondsValue) || Math.abs(now.getUTCSeconds() - displayedSecondsValue) > 1) {
                if (window.timeUpdateTimeout) {
                  clearTimeout(window.timeUpdateTimeout);
                }
                updateTime();
              }
            }
          }
        }, 1000);

        // Force time sync every 30 seconds as a backup measure
        window.timeRefreshInterval = setInterval(function () {
          if (window.timeUpdateTimeout) {
            clearTimeout(window.timeUpdateTimeout);
          }
          updateTime();
        }, 30000);
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initialize);
      } else {
        initialize();
      }

      // Theme configurations
      var themes = {
        theme1: {
          '--bg-color': '#0099ff',                // Keep original
          '--text-color': '#FFFFFF',              // Keep original
          '--highlight-color': '#000000',         // Keep original
          '--border-color': '#76B5C5',            // Keep original
          '--announcement-bg-color': '#000C17',    // Changed to darker bg
          '--announcement-text-color': '#FFFFFF',
          '--announcement-warning': '#ff0000',     // Keep original
          '--next-prayer-border-color': 'rgba(0, 0, 0, 0.8)' // Match highlight with transparency
        },
        theme2: {
          '--bg-color': '#001529',                // Keep original
          '--text-color': '#FFFFFF',              // Keep original
          '--highlight-color': '#00F0FF',         // Keep original
          '--border-color': '#0088FF',            // Keep original
          '--announcement-bg-color': '#000C17',    // Keep original
          '--announcement-text-color': '#FFFFFF',  // Keep original
          '--announcement-warning': '#ff0000',     // Keep original
          '--next-prayer-border-color': 'rgba(0, 240, 255, 0.8)' // Keep original
        },
        theme3: {
          '--bg-color': '#0A192F',                // Keep original
          '--text-color': '#FFFFFF',              // Keep original
          '--highlight-color': '#64FFDA',         // Keep original
          '--border-color': '#226e69',            // Keep original
          '--announcement-bg-color': '#000C17',    // Changed to darker bg
          '--announcement-text-color': '#FFFFFF',  // Match highlight color
          '--announcement-warning': '#ff0000',     // Keep original
          '--next-prayer-border-color': 'rgba(100, 255, 218, 0.8)' // Match highlight with transparency
        },
        theme4: {
          '--bg-color': '#FFFFFF',                // White background
          '--text-color': '#00F0FF',             // Cyan text as requested
          '--highlight-color': '#FF0000',        // Red highlight as requested
          '--border-color': '#00B4D8',           // Ocean blue borders
          '--announcement-bg-color': '#F8F9FA',  // Light gray for announcement
          '--announcement-text-color': '#00F0FF', // Red text to match highlight
          '--announcement-warning': '#FF4444',    // Lighter red for warnings
          '--next-prayer-border-color': 'rgba(255, 0, 0, 0.8)' // Red with transparency to match highlight
        },
        theme5: {
          '--bg-color': '#FFFFFF',                // White background
          '--text-color': '#13686e',             // Cyan text as requested
          '--highlight-color': '#FF0000',        // Red highlight as requested
          '--border-color': '#00B4D8',           // Ocean blue borders
          '--announcement-bg-color': '#F8F9FA',  // Light gray for announcement
          '--announcement-text-color': '#13686e', // Red text to match highlight
          '--announcement-warning': '#FF4444',    // Lighter red for warnings
          '--next-prayer-border-color': 'rgba(255, 0, 0, 0.8)' // Red with transparency to match highlight
        }
      };

      // Get all theme options
      var themeOptions = document.getElementsByClassName('theme-option');

      // Add click event to each theme option
      for (var i = 0; i < themeOptions.length; i++) {
        themeOptions[i].onclick = function () {
          var themeName = this.getAttribute('data-theme');
          var selectedTheme = themes[themeName];

          // Apply the theme
          applyTheme(selectedTheme);

          // Save theme preference (optional)
          try {
            localStorage.setItem('selectedTheme', themeName);
          } catch (e) {
            // Local storage not supported or disabled
            console.log('Local storage not available');
          }
        };
      }

      // Function to apply theme
      function applyTheme(theme) {
        var root = document.documentElement;
        for (var property in theme) {
          if (theme.hasOwnProperty(property)) {
            root.style.setProperty(property, theme[property]);
          }
        }
      }

      // Load saved theme preference on page load (optional)
      window.onload = function () {
        try {
          var savedTheme = localStorage.getItem('selectedTheme');
          if (savedTheme && themes[savedTheme]) {
            applyTheme(themes[savedTheme]);
          }
        } catch (e) {
          // Local storage not supported or disabled
          console.log('Local storage not available');
        }
      };
    </script>
</body>

</html>